# –ö–∞—Å—Ç–æ–º–Ω—ã–π WebSocket —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ Supabase Edge Functions

## üöÄ –ß—Ç–æ —ç—Ç–æ –¥–∞–µ—Ç

### ‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ WebSocket —Å–µ—Ä–≤–µ—Ä–∞:**
- **–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ –ª–æ–≥–∏–∫–æ–π WebSocket
- **–ù–∞–¥–µ–∂–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞** —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Realtime** Supabase
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞** —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**
- **–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** –≤ UI

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. **–°–æ–∑–¥–∞–Ω–∏–µ Edge Function**

1. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Supabase Dashboard**
2. **Edge Functions ‚Üí Create a new function**
3. **–ù–∞–∑–≤–∞–Ω–∏–µ:** `websocket-server`
4. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥** –∏–∑ `supabase/functions/websocket-server/index.ts`

### 2. **–î–µ–ø–ª–æ–π Edge Function**

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Supabase CLI
npm install -g supabase

# –í–æ–π–¥–∏—Ç–µ –≤ Supabase
supabase login

# –°–≤—è–∂–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç
supabase link --project-ref your-project-ref

# –î–µ–ø–ª–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
supabase functions deploy websocket-server
```

### 3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è**

–í Supabase Dashboard ‚Üí Edge Functions ‚Üí websocket-server ‚Üí Settings:

- `SUPABASE_URL` = –≤–∞—à URL –ø—Ä–æ–µ–∫—Ç–∞
- `SUPABASE_SERVICE_ROLE_KEY` = –≤–∞—à Service Role Key

### 4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞**

–ó–∞–º–µ–Ω–∏—Ç–µ `Chat.tsx` –Ω–∞ `ChatWebSocket.tsx`:

```typescript
// –í ProductDetail.tsx
import ChatWebSocket from '../components/ChatWebSocket'

// –ó–∞–º–µ–Ω–∏—Ç–µ <Chat /> –Ω–∞ <ChatWebSocket />
<ChatWebSocket
  sellerId={product?.seller_id}
  sellerName={product?.users?.full_name || '–ü—Ä–æ–¥–∞–≤–µ—Ü'}
  sellerAvatar={product?.users?.avatar_url}
  productTitle={product?.title}
/>
```

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### **WebSocket —Å–µ—Ä–≤–µ—Ä:**
1. **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
2. **–ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** –ø–æ userId
3. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
4. **–ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è** –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
5. **–£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏** –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏

### **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥:**
1. **–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É** –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
2. **–ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è** —Å userId
3. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è** —á–µ—Ä–µ–∑ WebSocket
4. **–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è** –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è** –ø—Ä–∏ –æ–±—Ä—ã–≤–µ —Å–≤—è–∑–∏

## üì± –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**
- **–ó–µ–ª–µ–Ω–∞—è —Ç–æ—á–∫–∞ (‚óè)** - WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω
- **"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..."** - WebSocket –æ—Ç–∫–ª—é—á–µ–Ω
- **–ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏** –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

### **–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞:**
- **–°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç** –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞** –∫ –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
- **–°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üîç –û—Ç–ª–∞–¥–∫–∞

### **–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:**
```
WebSocket: –ù–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
WebSocket: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: [userId]
WebSocket: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {...}
WebSocket: –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {...}
WebSocket: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é: [userId]
```

### **–õ–æ–≥–∏ –∫–ª–∏–µ–Ω—Ç–∞:**
```
Chat: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
Chat: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
Chat: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ WebSocket —É—Å–ø–µ—à–Ω–∞
Chat: –ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {...}
Chat: –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: [messageId]
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞:**
```bash
curl https://your-project.supabase.co/functions/v1/websocket-server/status
```

–û—Ç–≤–µ—Ç:
```json
{
  "status": "running",
  "connections": 2,
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

## üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **1. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ Supabase –ª–æ–∫–∞–ª—å–Ω–æ
supabase start

# –î–µ–ø–ª–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ
supabase functions deploy websocket-server --no-verify-jwt
```

### **2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:**
1. **–û—Ç–∫—Ä–æ–π—Ç–µ –¥–≤–∞ –æ–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞**
2. **–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –ø–æ–¥ —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏**
3. **–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç –º–µ–∂–¥—É –Ω–∏–º–∏**
4. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É** –≤ –¥—Ä—É–≥–æ–º –æ–∫–Ω–µ

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
- **WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ userId
- **–°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** –∑–∞—â–∏—â–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ

### **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ userId** –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π** –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã** —Å–æ–æ–±—â–µ–Ω–∏–π

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### **Supabase Dashboard:**
- **Edge Functions ‚Üí Logs** - –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
- **Database ‚Üí Logs** - –ª–æ–≥–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **API ‚Üí Logs** - –ª–æ–≥–∏ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

### **–ú–µ—Ç—Ä–∏–∫–∏:**
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π**
- **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞**

## üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### **–ü—Ä–æ–±–ª–µ–º–∞: "WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è"**
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL WebSocket —Å–µ—Ä–≤–µ—Ä–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Edge Function —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### **–ü—Ä–æ–±–ª–µ–º–∞: "–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è"**
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### **–ü—Ä–æ–±–ª–µ–º–∞: "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–æ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è"**
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
2. –£–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. –î–æ–±–∞–≤—å—Ç–µ heartbeat –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ WebSocket —Å–µ—Ä–≤–µ—Ä–∞:

- ‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞** —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ** —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
- ‚úÖ **–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- ‚úÖ **–ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Realtime** Supabase
- ‚úÖ **–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ –ª–æ–≥–∏–∫–æ–π —á–∞—Ç–∞

**–ö–∞—Å—Ç–æ–º–Ω—ã–π WebSocket —Å–µ—Ä–≤–µ—Ä –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∞–¥–µ–∂–Ω—É—é —Ä–∞–±–æ—Ç—É —á–∞—Ç–∞! üöÄ**
